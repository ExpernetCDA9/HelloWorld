<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inscription Utilisateur</title>
    <!-- Bootstrap CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
      body { background: #f7f7fb; }
      .card { box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
      .form-hint { font-size: .875rem; color: #6c757d; }
      .table-section { display: none; }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
          <div class="card">
            <div class="card-body p-4">
              <h1 class="h3 mb-3 text-center">Inscription</h1>
              <p class="text-muted text-center mb-4">Remplissez le formulaire ci-dessous pour cr√©er un compte.</p>

              <form id="signupForm" class="needs-validation" novalidate>
                <div class="mb-3">
                  <label for="email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="email" name="email" placeholder="prenom.nom@example.com" required>
                  <div class="invalid-feedback">Veuillez saisir une adresse email valide.</div>
                </div>

                <div class="mb-3">
                  <label for="password" class="form-label">Mot de passe</label>
                  <div class="input-group">
                    <input type="password"
                           class="form-control"
                           id="password"
                           name="password"
                           minlength="8"
                           pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*[^A-Za-z0-9]).{8,}"
                           aria-describedby="pwdHelp"
                           required>
                    <button class="btn btn-outline-secondary" type="button" id="togglePwd" aria-label="Afficher/masquer le mot de passe">üëÄ</button>
                    <div class="invalid-feedback">8+ caract√®res, au moins 1 minuscule, 1 majuscule et 1 symbole.</div>
                  </div>
                  <div id="pwdHelp" class="form-hint mt-1">8+ caract√®res, inclure: 1 minuscule, 1 majuscule, 1 symbole.</div>
                </div>

                <div class="mb-3">
                  <label for="passwordConfirm" class="form-label">Confirmer le mot de passe</label>
                  <input type="password" class="form-control" id="passwordConfirm" name="passwordConfirm" required>
                  <div class="invalid-feedback">Les mots de passe ne correspondent pas.</div>
                </div>

                <div class="mb-3">
                  <label for="dob" class="form-label">Date de naissance</label>
                  <input type="date" class="form-control" id="dob" name="dob" required>
                  <div class="invalid-feedback">La date doit √™tre ant√©rieure √† aujourd'hui.</div>
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary">S'inscrire</button>
                </div>
              </form>
            </div>
          </div>

          <section id="usersSection" class="table-section mt-4">
            <div class="card">
              <div class="card-body p-4">
                <h2 class="h5 mb-3">Utilisateurs du syst√®me</h2>
                <div class="table-responsive">
                  <table class="table table-striped align-middle mb-0" id="usersTable">
                    <thead>
                      <tr>
                        <th scope="col">Email</th>
                        <th scope="col">Date de naissance</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

        </div>
      </div>
    </div>

    <script>
      // Utilisateurs statiques initiaux (pas de serveur)
      const users = [
        { email: 'alice@example.com', dob: '1990-05-12' },
        { email: 'bob@example.com',   dob: '1985-11-03' },
      ];

      const form = document.getElementById('signupForm');
      const emailInput = document.getElementById('email');
      const pwdInput = document.getElementById('password');
      const confirmInput = document.getElementById('passwordConfirm');
      const dobInput = document.getElementById('dob');
      const usersSection = document.getElementById('usersSection');
      const usersTableBody = document.querySelector('#usersTable tbody');
      const togglePwdBtn = document.getElementById('togglePwd');

      // Fixer la date max pour interdire une date >= aujourd'hui
      (function setMaxDob() {
        const todayISO = new Date().toISOString().split('T')[0];
        dobInput.setAttribute('max', todayISO); // permet la s√©lection <= aujourd'hui
      })();

      // Afficher/Masquer le mot de passe
      togglePwdBtn.addEventListener('click', () => {
        const isPwd = pwdInput.type === 'password';
        pwdInput.type = isPwd ? 'text' : 'password';
        togglePwdBtn.setAttribute('aria-pressed', isPwd ? 'true' : 'false');
      });

      // Validation dynamique de la confirmation de mot de passe
      function syncConfirmValidity(showEmptyError = false) {
        if (!confirmInput) return;
        const pwd = pwdInput.value;
        const conf = confirmInput.value;
        if (conf.length === 0) {
          confirmInput.setCustomValidity(showEmptyError ? 'Veuillez confirmer le mot de passe' : '');
          return;
        }
        if (pwd === conf) {
          confirmInput.setCustomValidity('');
        } else {
          confirmInput.setCustomValidity('Les mots de passe ne correspondent pas');
        }
      }
      pwdInput.addEventListener('input', () => syncConfirmValidity(false));
      confirmInput.addEventListener('input', () => syncConfirmValidity(false));

      // Validation personnalis√©e de la date (strictement ant√©rieure √† aujourd'hui)
      function isDobValidStrict(dateStr) {
        if (!dateStr) return false;
        const d = new Date(dateStr);
        if (Number.isNaN(d.getTime())) return false;
        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return d < startOfToday;
      }

      function renderUsers() {
        usersTableBody.innerHTML = '';
        users.forEach(u => {
          const tr = document.createElement('tr');
          const tdEmail = document.createElement('td');
          tdEmail.textContent = u.email;
          const tdDob = document.createElement('td');
          // Affichage dd/mm/yyyy
          const parts = u.dob.split('-');
          const dobDisplay = parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : u.dob;
          tdDob.textContent = dobDisplay;
          tr.append(tdEmail, tdDob);
          usersTableBody.appendChild(tr);
        });
        usersSection.style.display = 'block';
      }

      function validatePassword(pwd) {
        const re = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[^A-Za-z0-9]).{8,}$/;
        return re.test(pwd);
      }

      // Validation et soumission (sans serveur)
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        // R√©initialiser √©tats custom
        dobInput.setCustomValidity('');
        pwdInput.setCustomValidity('');
        confirmInput.setCustomValidity('');

        // Checks HTML5
        const emailOK = emailInput.checkValidity();
        const pwdOK = validatePassword(pwdInput.value);
        if (!pwdOK) pwdInput.setCustomValidity('Mot de passe non conforme');
        // Confirme mot de passe
        const confirmOK = pwdInput.value === confirmInput.value && confirmInput.value.length > 0;
        if (!confirmOK) syncConfirmValidity(true);
        const dobOK = isDobValidStrict(dobInput.value);
        if (!dobOK) dobInput.setCustomValidity('Date invalide');

        if (emailOK && pwdOK && confirmOK && dobOK) {
          // Ajouter l'utilisateur et afficher la liste
          users.push({ email: emailInput.value.trim(), dob: dobInput.value });
          renderUsers();

          // Option UX: reset du formulaire et √©tats
          form.reset();
          form.classList.remove('was-validated');
          // Refixer max au cas o√π (changement de jour)
          const todayISO = new Date().toISOString().split('T')[0];
          dobInput.setAttribute('max', todayISO);
          // Nettoyer les validit√©s custom
          pwdInput.setCustomValidity('');
          confirmInput.setCustomValidity('');
        } else {
          // Affichage visuel Bootstrap
          form.classList.add('was-validated');
        }
      });

      // Afficher la liste statique uniquement apr√®s une soumission valide
      // (rien √† faire ici au chargement)
    </script>
  </body>
  </html>
